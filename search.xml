<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>自动获取网站icon</title>
      <link href="/2022/03/28/auto-get-icon/"/>
      <url>/2022/03/28/auto-get-icon/</url>
      
        <content type="html"><![CDATA[<div class="info"><blockquote><p>当我们在建立友链或者导航站点时，需要用到站点图标，虽然可以F12手动获取，但作为一个coder来说并不优雅，尤其图标多了之后，抑或是网站图标改变，所以最好有可以通过api来自动获取icon资源<br>虽然说，网上有很多，甚至百度谷歌一搜索就有一大堆免费的接口，但是并不推荐，除非你自己自建服务，否则很容易就失效了，或者一旦调用频繁就被ban了，这点我深有体会，所以最好是去嫖大厂的资源，稳定，钞能力，格局大。</p></blockquote></div><span id="more"></span><h4 id="谷歌接口"><a href="#谷歌接口" class="headerlink" title="谷歌接口"></a>谷歌接口</h4><blockquote><p>如果你的服务器在国外，且针对的是国外受众，<div style="display: inline-block"><img src="https://www.google.com/s2/favicons?domain=youtube.com" alt="youtube" loading="lazy"></div><div style="display: inline-block"><img src="https://www.google.com/s2/favicons?domain=facebook.com" alt="youtube" loading="lazy"></div><div style="display: inline-block"><img src="https://www.google.com/s2/favicons?domain=instagram.com" alt="youtube" loading="lazy"></div><div style="display: inline-block"><img src="https://www.google.com/s2/favicons?domain=baidu.com" alt="youtube" loading="lazy"></div><br>嗯，看起来还行。<br>上面的就是谷歌的一个获取网站icon的接口，接口地址为<br><code>https://www.google.com/s2/favicons?domain=</code><br>只要把需要获取的网址拼串，像这样<br><code>https://www.google.com/s2/favicons?domain=youtube.com</code><br>然后在需要调用的地方使用，比如<br><code>&lt;img src=&quot;https://www.google.com/s2/favicons?domain=youtube.com&quot;&gt;</code><br>最后他会返回一个图片地址，这是谷歌的cdn地址<br><code>https://t0.gstatic.com/faviconV2?client=SOCIAL&amp;type=FAVICON&amp;fallback_opts=TYPE,SIZE,URL&amp;url=http://youtube.com&amp;size=16</code></p></blockquote><h5 id="拼串"><a href="#拼串" class="headerlink" title="拼串"></a>拼串</h5><p>我们看到返回的size字段，默认为16，所以如果我们直接调用只会返回一个16像素的图标，如果我们想获取大一点的图标呢？</p><blockquote><p>尝试更改一下size字段，我们先试一下<code>32 64 128 256</code>，看有没有效果，<div style="display: inline-block"><img src="https://t0.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=http://youtube.com&size=32" alt="youtube" loading="lazy"></div><div style="display: inline-block"><img src="https://t0.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=http://youtube.com&size=64" alt="youtube" loading="lazy"></div><div style="display: inline-block"><img src="https://t0.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=http://youtube.com&size=128" alt="youtube" loading="lazy"></div><div style="display: inline-block"><img src="https://t0.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=http://youtube.com&size=256" alt="youtube" loading="lazy"></div><br>我们看到最后一张图片的大小为132，虽然我们设置的字段为256，因此我们得知，如果size字段设置过大，也只会返回原本的最大尺寸</p></blockquote><blockquote><p>我们再尝试一下是否可以拼串，<div style="display: inline-block"><img src="https://t0.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=http://jd.com&size=32" alt="jd" loading="lazy"></div></p></blockquote><p>可以得知，拼串是可以实现的，但是会失去全球cdn属性，但对于常规的站点来说，这已经够了</p><p>但是，如果你的网站受众是国内，那么你得有国外得服务器，推荐用自己的域名做反代，你也可以尝试下dnspod:</p><pre class="line-numbers language-none"><code class="language-none">https:&#x2F;&#x2F;statics.dnspod.cn&#x2F;proxy_favicon&#x2F;_&#x2F;favicon?domain&#x3D;url网址<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>但是很多站点获取不到，比如：获取百度、alibaba、网易、腾讯, 最终只有百度正常，并不推荐<div style="display: inline-block"><img src="https://statics.dnspod.cn/proxy_favicon/_/favicon?domain=www.baidu.com" alt="百度" loading="lazy"></div><div style="display: inline-block"><img src="https://statics.dnspod.cn/proxy_favicon/_/favicon?domain=www.alibaba.com" alt="alibaba" loading="lazy"></div><div style="display: inline-block"><img src="https://statics.dnspod.cn/proxy_favicon/_/favicon?domain=www.163.com" alt="网易" loading="lazy"></div><div style="display: inline-block"><img src="https://statics.dnspod.cn/proxy_favicon/_/favicon?domain=www.qq.com" alt="QQ" loading="lazy"></div></p></blockquote><p>或者你手里钞票多，自行搭建一个服务，已经有很多成熟的方案，直接去github借鉴（ctrl+c）就行了。<br>在这里直接上一个比较好用的PHP源码。</p><h4 id="自建源码"><a href="#自建源码" class="headerlink" title="自建源码"></a>自建源码</h4><p>网站目录新建一个Favicon.php</p><details>  <summary>Favicon.php</summary><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">namespace</span> <span class="token package">Jerrybendy<span class="token punctuation">\</span>Favicon</span><span class="token punctuation">;</span><span class="token comment">/** * Favicon 获取类 * * ## 关于缓存: * 本来类库中是调用Redis来做缓存，后来想了下，还是让这个类只专注于自己的业 * 务吧（获取图标）缓存这些操作交给外部来处理 * * @author Jerry Bendy * * @link   http://blog.icewingcc.com * */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Favicon</span><span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 是否使用调试模式，默认不启用     * 可以通过修改此变量的值以启用调试，将会在控制台中     * 或错误日志中输出一些运行相关的信息     *     * @var bool     */</span>    <span class="token keyword">public</span> <span class="token variable">$debug_mode</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 保存传入的参数,其中:     *     *    origin_url:     保存传入的url参数的原始字符串信息     *     *     *  以及一些额外的参数及暂存的数据     */</span>    <span class="token keyword">private</span> <span class="token variable">$params</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 完整的形如  http://xxx.xxx.com:8888 这样的地址     */</span>    <span class="token keyword">private</span> <span class="token variable">$full_host</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 包含获取到的最终的二进制数据     *     */</span>    <span class="token keyword">private</span> <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 最后一次请求花费的时间     *     * @var double     */</span>    <span class="token keyword">private</span> <span class="token variable">$_last_time_spend</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 最后一次请求消耗的内存     *     * @var string     */</span>    <span class="token keyword">private</span> <span class="token variable">$_last_memory_usage</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 文件映射，用于在规则匹配时直接返回内容     *     * @var array     */</span>    <span class="token keyword">private</span> <span class="token variable">$_file_map</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 默认图标，如果设置了此文件将会在请求失败时返回这个图标     *     * @var string     */</span>    <span class="token keyword">private</span> <span class="token variable">$_default_icon</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 获取网站Favicon并输出     *     * @param string $url    输入的网址     *                       (The input URL)     * @param bool   $return 是要求返回二进制内容还是直接显示它     * @throws \InvalidArgumentException     * @return string     *     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getFavicon</span><span class="token punctuation">(</span><span class="token variable">$url</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$return</span> <span class="token operator">=</span> <span class="token constant boolean">FALSE</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">/**         * 验证传入参数         */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$url</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>InvalidArgumentException</span><span class="token punctuation">(</span><span class="token constant">__CLASS__</span> <span class="token operator">.</span> <span class="token string single-quoted-string">': Url cannot be empty'</span><span class="token punctuation">,</span> <span class="token constant">E_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//</span>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">params</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'origin_url'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$url</span><span class="token punctuation">;</span>        <span class="token comment">//解析URL参数</span>        <span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">formatUrl</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$ret</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>InvalidArgumentException</span><span class="token punctuation">(</span><span class="token constant">__CLASS__</span> <span class="token operator">.</span> <span class="token string single-quoted-string">': Invalided url'</span><span class="token punctuation">,</span> <span class="token constant">E_WARNING</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">/**         * 开始获取图标过程         */</span>        <span class="token variable">$time_start</span> <span class="token operator">=</span> <span class="token function">microtime</span><span class="token punctuation">(</span><span class="token constant boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">_log_message</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Begin to get icon, '</span> <span class="token operator">.</span> <span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">/**         * get the favicon bin data         */</span>        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">/**         * 获取过程结束         * 计算时间及内存的占用信息         */</span>        <span class="token variable">$time_end</span> <span class="token operator">=</span> <span class="token function">microtime</span><span class="token punctuation">(</span><span class="token constant boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_last_time_spend</span> <span class="token operator">=</span> <span class="token variable">$time_end</span> <span class="token operator">-</span> <span class="token variable">$time_start</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_last_memory_usage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">function_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'memory_get_usage'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string single-quoted-string">'0'</span> <span class="token punctuation">:</span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token function">memory_get_usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'MB'</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">_log_message</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Get icon complate, spent time '</span> <span class="token operator">.</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_last_time_spend</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'s, Memory_usage '</span> <span class="token operator">.</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_last_memory_usage</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">/**         * 设置输出Header信息         * Output common header         *         */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$data</span> <span class="token operator">===</span> <span class="token constant boolean">FALSE</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_default_icon</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token variable">$data</span> <span class="token operator">=</span> @<span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_default_icon</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$return</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token variable">$data</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$data</span> <span class="token operator">!==</span> <span class="token constant boolean">FALSE</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$header</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    @<span class="token function">header</span><span class="token punctuation">(</span><span class="token variable">$header</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token keyword">echo</span> <span class="token variable">$data</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Content-type: application/json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'status'</span> <span class="token operator">=></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'msg'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'Unknown Error'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 获取输出 header     * 2019 添加缓存时间     *     * @since v2.1     * @return array     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">array</span><span class="token punctuation">(</span>            <span class="token string single-quoted-string">'X-Robots-Tag: noindex, nofollow'</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'Content-type: image/x-icon'</span><span class="token punctuation">,</span>          <span class="token string single-quoted-string">'Cache-Control: public, max-age=604800'</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 设置一组正则表达式到文件的映射，     * 用于在规则匹配成功时直接从本地或指定的URL处获取内容并返回     *     * @param array $map 映射内容必须是   正则表达式  =>  文件路径  的数组，     *                   文件通过 file_get_contents 函数读取，所以可以是本地文件或网络文件路径，     *                   但必须要保证对应的文件是一定能被读取的     * @return $this     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">setFileMap</span><span class="token punctuation">(</span><span class="token keyword type-hint">array</span> <span class="token variable">$map</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_file_map</span> <span class="token operator">=</span> <span class="token variable">$map</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * @param string $filePath     * @return $this     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">setDefaultIcon</span><span class="token punctuation">(</span><span class="token variable">$filePath</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_default_icon</span> <span class="token operator">=</span> <span class="token variable">$filePath</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 获取最终的Favicon图标数据     * 此为该类获取图标的核心函数     *     * @return bool|string     */</span>    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>         <span class="token comment">// 尝试匹配映射</span>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">_match_file_map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//判断data中有没有来自插件写入的内容</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span> <span class="token operator">!==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">_log_message</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Get icon from static file map, '</span> <span class="token operator">.</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">full_host</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//从网络获取图标</span>        <span class="token comment">//从源网址获取HTML内容并解析其中的LINK标签</span>        <span class="token variable">$html</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">params</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'origin_url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$html</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$html</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'status'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'OK'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">/*             * 2016-01-31             * FIX #1             * 对取到的HTML内容进行删除换行符的处理,避免link信息折行导致的正则匹配失败             */</span>            <span class="token variable">$html</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"\n"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"\r"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$html</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//匹配完整的LINK标签，再从LINK标签中获取HREF的值</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>@<span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/((&lt;link[^>]+rel=.(icon|shortcut icon|alternate icon|apple-touch-icon)[^>]+>))/i'</span><span class="token punctuation">,</span> <span class="token variable">$html</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'data'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$match_tag</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$match_tag</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$match_tag</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> @<span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/href=(\'|\")(.*?)\1/i'</span><span class="token punctuation">,</span> <span class="token variable">$match_tag</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$match_url</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$match_url</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$match_url</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token comment">//解析HTML中的相对URL 路径</span>                        <span class="token variable">$match_url</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">filterRelativeUrl</span><span class="token punctuation">(</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token variable">$match_url</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">params</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'origin_url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token variable">$icon</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token variable">$match_url</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$icon</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$icon</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'status'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'OK'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                            <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">_log_message</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Success get icon from <span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">params</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'origin_url'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span>, icon url is <span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$match_url</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span> <span class="token operator">=</span> <span class="token variable">$icon</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'data'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                        <span class="token punctuation">&#125;</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//用来在第一次获取后保存可能的重定向后的地址</span>        <span class="token variable">$redirected_url</span> <span class="token operator">=</span> <span class="token variable">$html</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'real_url'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment">//未能从LINK标签中获取图标（可能是网址无法打开，或者指定的文件无法打开，或未定义图标地址）</span>        <span class="token comment">//将使用网站根目录的文件代替</span>        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">full_host</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/favicon.ico'</span><span class="token punctuation">,</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$data</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'status'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'OK'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">_log_message</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Success get icon from website root: <span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">full_host</span><span class="token punctuation">&#125;</span></span>/favicon.ico"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'data'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//如果直接取根目录文件返回了301或404，先读取重定向，再从重定向的网址获取</span>            <span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">formatUrl</span><span class="token punctuation">(</span><span class="token variable">$redirected_url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$ret</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">//最后的尝试，从重定向后的网址根目录获取favicon文件</span>                <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">full_host</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/favicon.ico'</span><span class="token punctuation">,</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$data</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'status'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'OK'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">_log_message</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Success get icon from redirect file: <span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">full_host</span><span class="token punctuation">&#125;</span></span>/favicon.ico"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'data'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>                <span class="token comment">/**         * 从其他api最后获取图像 -----------------------------------------------------         *          */</span>        <span class="token comment">// if ($this->data == NULL) &#123;</span>        <span class="token comment">//     $thrurl='https://api.ooii.io/icon/api.php?url=';</span>        <span class="token comment">//     $icon = file_get_contents($thrurl.$this->full_host);  </span>        <span class="token comment">//     //$this->_log_message("--图标 md5 值为".md5($icon));</span>        <span class="token comment">//     if($icon &amp;&amp; md5($icon)!="3ca64f83fdcf25135d87e08af65e68c9")&#123;  //判断是否为对方 api 返回的默认图标，可通过上行 log 查看</span>        <span class="token comment">//         $this->_log_message("--从 &#123;$thrurl&#125; 获取到图标");</span>        <span class="token comment">//         $this->data = $icon; </span>        <span class="token comment">//     &#125; </span>        <span class="token comment">// &#125;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//各个方法都试过了，还是获取不到。。。</span>            <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">_log_message</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Cannot get icon from <span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">params</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'origin_url'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token constant boolean">FALSE</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 解析一个完整的URL中并返回其中的协议、域名和端口部分     * 同时会设置类中的parsed_url和full_host属性     *     * @param $url     * @return bool|string     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">formatUrl</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">/**         * 尝试解析URL参数，如果解析失败的话再加上http前缀重新尝试解析         *         */</span>        <span class="token variable">$parsed_url</span> <span class="token operator">=</span> <span class="token function">parse_url</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$parsed_url</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'host'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token variable">$parsed_url</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'host'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//在URL的前面加上http://</span>            <span class="token comment">// add the prefix</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/^https?:\/\/.*/'</span><span class="token punctuation">,</span> <span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token variable">$url</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'http://'</span> <span class="token operator">.</span> <span class="token variable">$url</span><span class="token punctuation">;</span>            <span class="token comment">//解析URL并将结果保存到 $this->url</span>            <span class="token variable">$parsed_url</span> <span class="token operator">=</span> <span class="token function">parse_url</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$parsed_url</span> <span class="token operator">==</span> <span class="token constant boolean">FALSE</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token constant boolean">FALSE</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token comment">/**                 * 能成功解析的话就可以设置原始URL为这个添加过http://前缀的URL                 */</span>                <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">params</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'origin_url'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$url</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">full_host</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$parsed_url</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'scheme'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$parsed_url</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'scheme'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">'http'</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'://'</span> <span class="token operator">.</span> <span class="token variable">$parsed_url</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'host'</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$parsed_url</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'port'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string single-quoted-string">':'</span> <span class="token operator">.</span> <span class="token variable">$parsed_url</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'port'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">full_host</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 把从HTML源码中获取的相对路径转换成绝对路径     *     * @see 函数详情： http://blog.icewingcc.com/php-conv-addr-re-ab-2.html     *     * @param string $url HTML中获取的网址     * @param string $URI 用来参考判断的原始地址     * @return string 返回修改过的网址     */</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">filterRelativeUrl</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token variable">$URI</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">//STEP1: 先去判断URL中是否包含协议，如果包含说明是绝对地址则可以原样返回</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'://'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">FALSE</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token variable">$url</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//STEP2: 解析传入的URI</span>        <span class="token variable">$URI_part</span> <span class="token operator">=</span> <span class="token function">parse_url</span><span class="token punctuation">(</span><span class="token variable">$URI</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$URI_part</span> <span class="token operator">==</span> <span class="token constant boolean">FALSE</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token constant boolean">FALSE</span><span class="token punctuation">;</span>        <span class="token variable">$URI_root</span> <span class="token operator">=</span> <span class="token variable">$URI_part</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'scheme'</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'://'</span> <span class="token operator">.</span> <span class="token variable">$URI_part</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'host'</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$URI_part</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'port'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string single-quoted-string">':'</span> <span class="token operator">.</span> <span class="token variable">$URI_part</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'port'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//STEP3: 如果URL以左斜线开头，表示位于根目录</span>        <span class="token comment">// 如果URL以 // 开头,表示是省略协议的绝对路径,可以添加协议后返回</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'//'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token variable">$URI_part</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'scheme'</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string single-quoted-string">':'</span> <span class="token operator">.</span> <span class="token variable">$url</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'/'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token variable">$URI_root</span> <span class="token operator">.</span> <span class="token variable">$url</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//STEP4: 不位于根目录，也不是绝对路径，考虑如果不包含'./'的话，需要把相对地址接在原URL的目录名上</span>        <span class="token variable">$URI_dir</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$URI_part</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'path'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$URI_part</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'path'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string single-quoted-string">'/'</span> <span class="token operator">.</span> <span class="token function">ltrim</span><span class="token punctuation">(</span><span class="token function">dirname</span><span class="token punctuation">(</span><span class="token variable">$URI_part</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'path'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'./'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token constant boolean">FALSE</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$URI_dir</span> <span class="token operator">!=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token variable">$URI_root</span> <span class="token operator">.</span> <span class="token variable">$URI_dir</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/'</span> <span class="token operator">.</span> <span class="token variable">$url</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token variable">$URI_root</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/'</span> <span class="token operator">.</span> <span class="token variable">$url</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//STEP5: 如果相对路径中包含'../'或'./'表示的目录，需要对路径进行解析并递归</span>        <span class="token comment">//STEP5.1: 把路径中所有的'./'改为'/'，'//'改为'/'</span>        <span class="token variable">$url</span> <span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/[^\.]\.\/|\/\//'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'/'</span><span class="token punctuation">,</span> <span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'./'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token variable">$url</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//STEP5.2: 使用'/'分割URL字符串以获取目录的每一部分进行判断</span>        <span class="token variable">$URI_full_dir</span> <span class="token operator">=</span> <span class="token function">ltrim</span><span class="token punctuation">(</span><span class="token variable">$URI_dir</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/'</span> <span class="token operator">.</span> <span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$URL_arr</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/'</span><span class="token punctuation">,</span> <span class="token variable">$URI_full_dir</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 这里为了解决有些网站在根目录下的文件也使用 ../img/favicon.ico 这种形式的错误,</span>        <span class="token comment">// 对这种本来不合理的路径予以通过, 并忽略掉前面的两个点 (没错, 我说的是 gruntjs 的官网)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$URL_arr</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'..'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">array_shift</span><span class="token punctuation">(</span><span class="token variable">$URL_arr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//因为数组的第一个元素不可能为'..'，所以这里从第二个元素可以循环</span>        <span class="token variable">$dst_arr</span> <span class="token operator">=</span> <span class="token variable">$URL_arr</span><span class="token punctuation">;</span>  <span class="token comment">//拷贝一个副本，用于最后组合URL</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$URL_arr</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$URL_arr</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'..'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token variable">$j</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token constant boolean">TRUE</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$dst_arr</span><span class="token punctuation">[</span><span class="token variable">$i</span> <span class="token operator">-</span> <span class="token variable">$j</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$dst_arr</span><span class="token punctuation">[</span><span class="token variable">$i</span> <span class="token operator">-</span> <span class="token variable">$j</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant boolean">FALSE</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token variable">$dst_arr</span><span class="token punctuation">[</span><span class="token variable">$i</span> <span class="token operator">-</span> <span class="token variable">$j</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant boolean">FALSE</span><span class="token punctuation">;</span>                        <span class="token variable">$dst_arr</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant boolean">FALSE</span><span class="token punctuation">;</span>                        <span class="token keyword">break</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                        <span class="token variable">$j</span><span class="token operator">++</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//STEP6: 组合最后的URL并返回</span>        <span class="token variable">$dst_str</span> <span class="token operator">=</span> <span class="token variable">$URI_root</span><span class="token punctuation">;</span>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$dst_arr</span> <span class="token keyword">as</span> <span class="token variable">$val</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$val</span> <span class="token operator">!=</span> <span class="token constant boolean">FALSE</span><span class="token punctuation">)</span>                <span class="token variable">$dst_str</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">'/'</span> <span class="token operator">.</span> <span class="token variable">$val</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token variable">$dst_str</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 从指定URL获取文件     * 2019 添加请求内容判断     *      * @param string $url     * @param bool   $isimg 是否为图片     * @param int    $timeout 超时值，默认为10秒     * @return string 成功返回获取到的内容，同时设置 $this->content，失败返回FALSE     */</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">getFile</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token variable">$isimg</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token variable">$timeout</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$ch</span> <span class="token operator">=</span> <span class="token function">curl_init</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_CONNECTTIMEOUT</span><span class="token punctuation">,</span> <span class="token variable">$timeout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">/*         * 2019-06-20         * 修复ssl的错误         */</span>        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_SSL_VERIFYPEER</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_SSL_VERIFYHOST</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_RETURNTRANSFER</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_FAILONERROR</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//执行重定向获取</span>        <span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">curlExecFollow</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$isimg</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token variable">$mime</span><span class="token operator">=</span><span class="token function">curl_getinfo</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLINFO_CONTENT_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$mimeArray</span><span class="token operator">=</span><span class="token function">explode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/'</span><span class="token punctuation">,</span><span class="token variable">$mime</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token variable">$arr</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>            <span class="token string single-quoted-string">'status'</span>   <span class="token operator">=></span> <span class="token string single-quoted-string">'FAIL'</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'data'</span>     <span class="token operator">=></span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>            <span class="token string single-quoted-string">'real_url'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">''</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$isimg</span> <span class="token operator">||</span>  <span class="token variable">$mimeArray</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'image'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$ret</span> <span class="token operator">!=</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token variable">$status</span> <span class="token operator">=</span> <span class="token function">curl_getinfo</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLINFO_HTTP_CODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token variable">$arr</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>                    <span class="token string single-quoted-string">'status'</span>   <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token variable">$status</span> <span class="token operator">>=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$status</span> <span class="token operator">&lt;=</span> <span class="token number">299</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant boolean">TRUE</span> <span class="token punctuation">:</span> <span class="token constant boolean">FALSE</span><span class="token punctuation">,</span>                    <span class="token string single-quoted-string">'data'</span>     <span class="token operator">=></span> <span class="token variable">$ret</span><span class="token punctuation">,</span>                    <span class="token string single-quoted-string">'real_url'</span> <span class="token operator">=></span> <span class="token function">curl_getinfo</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLINFO_EFFECTIVE_URL</span><span class="token punctuation">)</span>                <span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token function">curl_close</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token variable">$arr</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">_log_message</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"不是图片：<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$url</span><span class="token punctuation">&#125;</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token variable">$arr</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 使用跟综重定向的方式查找被301/302跳转后的实际地址，并执行curl_exec     * 代码来自： http://php.net/manual/zh/function.curl-setopt.php#102121     *     * @param resource $ch          CURL资源句柄     * @param int      $maxredirect 最大允许的重定向次数     * @return string     */</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">curlExecFollow</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token variable">$maxredirect</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         <span class="token variable">$mr</span> <span class="token operator">=</span> <span class="token variable">$maxredirect</span> <span class="token operator">===</span> <span class="token constant">null</span> <span class="token operator">?</span> <span class="token number">5</span> <span class="token punctuation">:</span> <span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$maxredirect</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ini_get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'open_basedir'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string single-quoted-string">''</span> <span class="token operator">&amp;&amp;</span> <span class="token function">ini_get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'safe_mode'</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'Off'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>             <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_FOLLOWLOCATION</span><span class="token punctuation">,</span> <span class="token variable">$mr</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_MAXREDIRS</span><span class="token punctuation">,</span> <span class="token variable">$mr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>             <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_FOLLOWLOCATION</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$mr</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                 <span class="token variable">$newurl</span> <span class="token operator">=</span> <span class="token function">curl_getinfo</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLINFO_EFFECTIVE_URL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token variable">$rch</span> <span class="token operator">=</span> <span class="token function">curl_copy_handle</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$rch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_HEADER</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$rch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_NOBODY</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$rch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_NOSIGNAL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$rch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_CONNECTTIMEOUT_MS</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$rch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_FORBID_REUSE</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$rch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_RETURNTRANSFER</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>                     <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$rch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_URL</span><span class="token punctuation">,</span> <span class="token variable">$newurl</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token variable">$header</span> <span class="token operator">=</span> <span class="token function">curl_exec</span><span class="token punctuation">(</span><span class="token variable">$rch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">curl_errno</span><span class="token punctuation">(</span><span class="token variable">$rch</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                         <span class="token variable">$code</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                     <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                         <span class="token variable">$code</span> <span class="token operator">=</span> <span class="token function">curl_getinfo</span><span class="token punctuation">(</span><span class="token variable">$rch</span><span class="token punctuation">,</span> <span class="token constant">CURLINFO_HTTP_CODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$code</span> <span class="token operator">==</span> <span class="token number">301</span> <span class="token operator">||</span> <span class="token variable">$code</span> <span class="token operator">==</span> <span class="token number">302</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                             <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/Location:(.*?)\n/'</span><span class="token punctuation">,</span> <span class="token variable">$header</span><span class="token punctuation">,</span> <span class="token variable">$matches</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                             <span class="token variable">$newurl</span> <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span><span class="token function">array_pop</span><span class="token punctuation">(</span><span class="token variable">$matches</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                             <span class="token comment">/**                             * 这里由于部分网站返回的 Location 的值可能是相对网址, 所以还需要做一步                             * 转换成完整地址的操作                             *                             * @since v2.2.2                             */</span>                            <span class="token variable">$newurl</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">filterRelativeUrl</span><span class="token punctuation">(</span><span class="token variable">$newurl</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">params</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'origin_url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                             <span class="token variable">$code</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                         <span class="token punctuation">&#125;</span>                     <span class="token punctuation">&#125;</span>                 <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$code</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">--</span><span class="token variable">$mr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token function">curl_close</span><span class="token punctuation">(</span><span class="token variable">$rch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$mr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$maxredirect</span> <span class="token operator">===</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                         <span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Too many redirects. When following redirects, libcurl hit the maximum amount.'</span><span class="token punctuation">,</span> <span class="token constant">E_USER_WARNING</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                         <span class="token variable">$maxredirect</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                     <span class="token punctuation">&#125;</span>                     <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>                 <span class="token punctuation">&#125;</span>                 <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_URL</span><span class="token punctuation">,</span> <span class="token variable">$newurl</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token punctuation">&#125;</span>         <span class="token punctuation">&#125;</span>         <span class="token keyword">return</span> <span class="token function">curl_exec</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">&#125;</span>     <span class="token comment">/**     * 在设定的映射条件中循环并尝试匹配每一条规则，     * 在条件匹配时返回对应的文件内容     *     * @return null|string     */</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">_match_file_map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_file_map</span> <span class="token keyword">as</span> <span class="token variable">$rule</span> <span class="token operator">=></span> <span class="token variable">$file</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$rule</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">full_host</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> @<span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 如果开启了调试模式，将会在控制台或错误日志中输出一些信息     *     * @param $message     */</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">_log_message</span><span class="token punctuation">(</span><span class="token variable">$message</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">debug_mode</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">error_log</span><span class="token punctuation">(</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'d/m/Y H:i:s : '</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token variable">$message</span><span class="token operator">.</span><span class="token constant">PHP_EOL</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"./my-errors.log"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></details><p>新建get.php</p><details>  <summary>get.php</summary><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token comment">// 如果自用，可加个密码</span><span class="token comment">// $auth = isset($_GET['auth']) ? $_GET['auth'] : '';</span><span class="token comment">// define('AUTH', true);</span><span class="token comment">// define('AUTH_SECRET', 'jinitaimei'); //设定鉴权密码</span><span class="token comment">// if (AUTH) &#123;</span><span class="token comment">//     if ($auth == '' || $auth != AUTH_SECRET) &#123;</span><span class="token comment">//         // 直接返回403</span><span class="token comment">//         // http_response_code(403);</span><span class="token comment">//         // echo '😵出错了！缺少参数：auth';</span><span class="token comment">//         // exit;</span><span class="token comment">//         // 或者输出一张图片</span><span class="token comment">//         header('content-type:image/png;');</span><span class="token comment">//         header('Location:https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fhbimg.huabanimg.com%2F31d4ecf35a14b1269b987e1326d1369534b6f6cc4f757-oAIvsv_fw658&amp;refer=http%3A%2F%2Fhbimg.huabanimg.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=auto?sec=1649818489&amp;t=d742b9b604af14f375d4c22b6f5cb9b0');</span><span class="token comment">//     &#125;</span><span class="token comment">// &#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">http_response_code</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">require</span> <span class="token string double-quoted-string">"./Favicon.php"</span><span class="token punctuation">;</span><span class="token variable">$favicon</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Jerrybendy<span class="token punctuation">\</span>Favicon<span class="token punctuation">\</span>Favicon</span><span class="token punctuation">;</span><span class="token comment">/* ------ 参数设置 ------ */</span><span class="token variable">$defaultIco</span><span class="token operator">=</span><span class="token string single-quoted-string">'favicon.png'</span><span class="token punctuation">;</span>   <span class="token comment">//默认图标路径</span><span class="token variable">$expire</span> <span class="token operator">=</span> <span class="token number">2592000</span><span class="token punctuation">;</span>           <span class="token comment">//缓存有效期30天, 单位为:秒，为0时不缓存</span><span class="token comment">/* ------ 参数设置 ------ */</span><span class="token comment">/** * 设置默认图标 */</span><span class="token variable">$favicon</span><span class="token operator">-></span><span class="token function">setDefaultIcon</span><span class="token punctuation">(</span><span class="token variable">$defaultIco</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/** * 检测URL参数 */</span><span class="token variable">$url</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">/* * 格式化 URL, 并尝试读取缓存 */</span><span class="token variable">$formatUrl</span> <span class="token operator">=</span> <span class="token variable">$favicon</span><span class="token operator">-></span><span class="token function">formatUrl</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$expire</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token variable">$favicon</span><span class="token operator">-></span><span class="token function">getFavicon</span><span class="token punctuation">(</span><span class="token variable">$formatUrl</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">exit</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>    <span class="token variable">$defaultMD5</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$defaultIco</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token class-name static-context">Cache</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$formatUrl</span><span class="token punctuation">,</span><span class="token variable">$defaultMD5</span><span class="token punctuation">,</span><span class="token variable">$expire</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$data</span> <span class="token operator">!==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$favicon</span><span class="token operator">-></span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$header</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            @<span class="token function">header</span><span class="token punctuation">(</span><span class="token variable">$header</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">echo</span> <span class="token variable">$data</span><span class="token punctuation">;</span>        <span class="token keyword">exit</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 缓存中没有指定的内容时, 重新获取内容并缓存起来     */</span>    <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token variable">$favicon</span><span class="token operator">-></span><span class="token function">getFavicon</span><span class="token punctuation">(</span><span class="token variable">$formatUrl</span><span class="token punctuation">,</span> <span class="token constant boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token variable">$defaultMD5</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token variable">$expire</span> <span class="token operator">=</span> <span class="token number">43200</span><span class="token punctuation">;</span> <span class="token comment">//如果返回默认图标，设置过期时间为12小时。Cache::get 方法中需同时修改</span>    <span class="token punctuation">&#125;</span>    <span class="token class-name static-context">Cache</span><span class="token operator">::</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token variable">$formatUrl</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">,</span> <span class="token variable">$expire</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$favicon</span><span class="token operator">-></span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$header</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        @<span class="token function">header</span><span class="token punctuation">(</span><span class="token variable">$header</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">echo</span> <span class="token variable">$content</span><span class="token punctuation">;</span>    <span class="token keyword">exit</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token variable">$type</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$type</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>       <span class="token comment">//Json格式解析</span>    <span class="token keyword">case</span> <span class="token string single-quoted-string">'json'</span><span class="token punctuation">:</span>    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token keyword">array</span> <span class="token punctuation">(</span>        <span class="token string single-quoted-string">'state'</span> <span class="token operator">=></span> <span class="token number">200</span><span class="token punctuation">,</span>        <span class="token string single-quoted-string">'iconurl'</span> <span class="token operator">=></span> <span class="token variable">$iconurl</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Content-type:text/json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Access-Control-Allow-Origin: *'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Access-Control-Allow-Headers: Origin, X-Requested-With, Content-Type, Accept"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Access-Control-Allow-Methods: GET, POST, PUT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token comment">//IMG</span>    <span class="token keyword">default</span><span class="token punctuation">:</span>    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'content-type:image/png;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Location:"</span><span class="token operator">.</span><span class="token variable">$result</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'iconurl'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">/** * 缓存类 */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Cache</span><span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 获取缓存的值, 不存在时返回 null     *     * @param $key     * @param $default  默认图片     * @param $expire   过期时间     * @return string     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">get</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$default</span><span class="token punctuation">,</span> <span class="token variable">$expire</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$dir</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'cache'</span><span class="token punctuation">;</span> <span class="token comment">//图标缓存目录</span>               <span class="token comment">//$f = md5( strtolower( $key ) );</span>        <span class="token variable">$f</span> <span class="token operator">=</span> <span class="token function">parse_url</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'host'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token variable">$dir</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/'</span> <span class="token operator">.</span> <span class="token variable">$f</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'.txt'</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">is_file</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token variable">$default</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token variable">$expire</span> <span class="token operator">=</span> <span class="token number">43200</span><span class="token punctuation">;</span> <span class="token comment">//如果返回默认图标，过期时间为12小时。</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">filemtime</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token variable">$expire</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token constant">null</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">else</span><span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token variable">$data</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>        <span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token constant">null</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 设置缓存     *     * @param $key     * @param $value     * @param $expire   过期时间     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">set</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">,</span> <span class="token variable">$expire</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$dir</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'cache'</span><span class="token punctuation">;</span> <span class="token comment">//图标缓存目录</span>                <span class="token comment">//$f = md5( strtolower( $key ) );</span>        <span class="token variable">$f</span> <span class="token operator">=</span> <span class="token function">parse_url</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'host'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token variable">$dir</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/'</span> <span class="token operator">.</span> <span class="token variable">$f</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'.txt'</span><span class="token punctuation">;</span>                <span class="token comment">//如果缓存目录不存在则创建</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_dir</span><span class="token punctuation">(</span><span class="token variable">$dir</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$dir</span><span class="token punctuation">,</span><span class="token number">0777</span><span class="token punctuation">,</span><span class="token constant boolean">true</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'创建缓存目录失败！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">is_file</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">filemtime</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token variable">$expire</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token variable">$imgdata</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"w"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Unable to open file!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//w  重写  a追加</span>            <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$imgdata</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$imgdata</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></details>最后访问域名/get.php?url=域名，即可。]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tool </tag>
            
            <tag> icon </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>创建一个可以定时提醒喝水的钉钉机器人</title>
      <link href="/2022/02/21/ding-ding-drink-boot/"/>
      <url>/2022/02/21/ding-ding-drink-boot/</url>
      
        <content type="html"><![CDATA[<h4 id="需要用到的环境"><a href="#需要用到的环境" class="headerlink" title="需要用到的环境"></a>需要用到的环境</h4><blockquote><p>能运行电脑版钉钉的Windows或者Mac用于获取机器人地址<br>能长期稳定运行node.js环境的电脑或者服务器(需要网络连接)，可以是你自己的电脑，服务器，软路由，群晖，你们公司闲置的电脑或者docker一个node<br><em><strong>【可选】</strong></em>，如果需要天气预报，需要自行申请百度开发者api密钥，<a href="https://lbsyun.baidu.com/index.php?title=webapi/weather">百度天气API开发文档</a>, 以及<a href="https://lbsyun.baidu.com/apiconsole/key#/home">申请密钥</a></p></blockquote><span id="more"></span><h4 id="获取钉钉机器人地址"><a href="#获取钉钉机器人地址" class="headerlink" title="获取钉钉机器人地址"></a>获取钉钉机器人地址</h4><ul><li>下载电脑版钉钉，<a href="https://page.dingtalk.com/wow/z/dingtalk/default/dddownload-index">下载地址</a></li><li>新建一个群，加入你想通知的人，如果你想只发送给自己，踢掉其他人即可。</li><li>群设置 =&gt; 群智能助手 =&gt; 添加自定义机器人(webhook) =&gt; 安全设置勾选加签</li><li>最后复制好webhook地址和加签密钥</li></ul><h4 id="服务端部署"><a href="#服务端部署" class="headerlink" title="服务端部署"></a>服务端部署</h4><ul><li>在你的服务器(或电脑)上安装好node.js环境，<a href="https://nodejs.org/zh-cn/">官方下载</a>，Linux和mac请自行查阅安装教程安装，Linux推荐使用docker安装</li><li>检查安装，windows下打开Node.js command prompt程序，输入<code>node -v</code>,出现版本号即为正常，检测PATH环境变量是否配置了Node.js，点击开始=&gt;运行=&gt;输入<code>cmd</code> =&gt; 输入命令<code>path</code>，显示中有node.js即为正常。Linux同理。</li><li>在你喜欢的位置新建一个项目文件夹，命名随意，打开文件夹，新建一个index.js</li><li><h5 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h5><h6 id="安装yarn"><a href="#安装yarn" class="headerlink" title="安装yarn"></a>安装yarn</h6><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">npm i -g yarn<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h6 id="安装定时模块"><a href="#安装定时模块" class="headerlink" title="安装定时模块"></a>安装定时模块</h6><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">yarn add node-schedule<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h6 id="安装加密"><a href="#安装加密" class="headerlink" title="安装加密"></a>安装加密</h6><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">yarn add crypto<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h6 id="安装node-fetch-用于获取天气预报"><a href="#安装node-fetch-用于获取天气预报" class="headerlink" title="安装node-fetch // 用于获取天气预报"></a>安装node-fetch // 用于获取天气预报</h6><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">yarn add node-fetch<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>编辑package.json，增加<code>&quot;type&quot;: &quot;module&quot;</code>，(放在json第一级)</li></ul><h4 id="加入功能"><a href="#加入功能" class="headerlink" title="加入功能"></a>加入功能</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> schedule <span class="token keyword">from</span> <span class="token string">'node-schedule'</span><span class="token keyword">import</span> fetch <span class="token keyword">from</span> <span class="token string">'node-fetch'</span><span class="token keyword">import</span> crypto <span class="token keyword">from</span> <span class="token string">'crypto'</span><span class="token punctuation">;</span><span class="token comment">// 第一个参数为[秒 分 时 ]</span><span class="token comment">// * * * * * *</span><span class="token comment">// ┬ ┬ ┬ ┬ ┬ ┬</span><span class="token comment">// │ │ │ │ │ │</span><span class="token comment">// │ │ │ │ │ └ day of week (0 - 7) (0 or 7 is Sun)</span><span class="token comment">// │ │ │ │ └───── month (1 - 12)</span><span class="token comment">// │ │ │ └────────── day of month (1 - 31)</span><span class="token comment">// │ │ └─────────────── hour (0 - 23)</span><span class="token comment">// │ └──────────────────── minute (0 - 59)</span><span class="token comment">// └───────────────────────── second (0 - 59, OPTIONAL)</span><span class="token comment">// 6个占位符从左到右分别代表：秒、分、时、日、月、周几</span><span class="token comment">// '*'表示通配符，匹配任意，当秒是'*'时，表示任意秒数都触发，其它类推</span><span class="token comment">// 下面可以看看以下传入参数分别代表的意思</span><span class="token comment">// 每分钟的第30秒触发： '30 * * * * *'</span><span class="token comment">// 每小时的1分30秒触发 ：'30 1 * * * *'</span><span class="token comment">// 每天的凌晨1点1分30秒触发 ：'30 1 1 * * *'</span><span class="token comment">// 每月的1日1点1分30秒触发 ：'30 1 1 1 * *'</span><span class="token comment">// 2016年的1月1日1点1分30秒触发 ：'30 1 1 1 2016 *'</span><span class="token comment">// 每周1的1点1分30秒触发 ：'30 1 1 * * 1'</span><span class="token keyword">const</span> job <span class="token operator">=</span> schedule<span class="token punctuation">.</span><span class="token function">scheduleJob</span><span class="token punctuation">(</span><span class="token string">'* 00 * * * *'</span><span class="token punctuation">,</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token comment">//机器人地址</span>  <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">你的钉钉webhook地址</span><span class="token template-punctuation string">`</span></span>  <span class="token comment">//签名验证</span>  <span class="token keyword">let</span> secret <span class="token operator">=</span> <span class="token string">'加签密钥'</span>  <span class="token keyword">let</span> time <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//当前时间戳</span>  <span class="token keyword">let</span> stringToSign <span class="token operator">=</span> time <span class="token operator">+</span> <span class="token string">"\n"</span> <span class="token operator">+</span> secret<span class="token punctuation">;</span>   <span class="token keyword">let</span> base <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHmac</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>stringToSign<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//encode</span>  <span class="token keyword">let</span> sign <span class="token operator">=</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span> <span class="token comment">//二次encode</span>  url <span class="token operator">=</span> url<span class="token operator">+</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&amp;timestamp=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>time<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&amp;sign=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>sign<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span> <span class="token comment">//拼串得到最终的URL</span>  <span class="token keyword">let</span> location <span class="token operator">=</span> <span class="token string">'110100'</span> <span class="token comment">//设置城市编码查询 https://mapopen-website-wiki.cdn.bcebos.com/cityList/weather_district_id.csv，可以自行洗成json等</span>  <span class="token comment">// 下面时可选的天气预报服务</span>  <span class="token keyword">let</span> ak <span class="token operator">=</span> <span class="token string">'你的百度密钥'</span>  <span class="token keyword">let</span> bdurl <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://api.map.baidu.com/weather/v1/?district_id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>district<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&amp;data_type=all&amp;ak=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>ak<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">  //GET请求</span><span class="token template-punctuation string">`</span></span>  <span class="token comment">// 获取天气</span>  <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>bdurl<span class="token punctuation">)</span>  <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 根据钉钉文档构建json格式的数据, </span>  <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string-property property">"msgtype"</span><span class="token operator">:</span> <span class="token string">"markdown"</span><span class="token punctuation">,</span>    <span class="token string-property property">"markdown"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token string-property property">"title"</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>data<span class="token punctuation">.</span>result<span class="token punctuation">.</span>location<span class="token punctuation">.</span>city<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>data<span class="token punctuation">.</span>result<span class="token punctuation">.</span>location<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>        <span class="token string-property property">"text"</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>data<span class="token punctuation">.</span>result<span class="token punctuation">.</span>now<span class="token punctuation">.</span>text<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">        现在是</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">        起来活动，喝杯水        </span><span class="token template-punctuation string">`</span></span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'post'</span><span class="token punctuation">,</span>    <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span><span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> msg <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="百度天气返回json示例代码"><a href="#百度天气返回json示例代码" class="headerlink" title="百度天气返回json示例代码"></a>百度天气返回json示例代码</h5><details>  <summary>请求类型为all的响应示例（部分字段需开通高级权限，具体请参考文档说明）</summary>    <pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>    <span class="token property">"status"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>    <span class="token property">"result"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>        <span class="token property">"location"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>            <span class="token property">"country"</span><span class="token operator">:</span><span class="token string">"中国"</span><span class="token punctuation">,</span>            <span class="token property">"province"</span><span class="token operator">:</span><span class="token string">"北京市"</span><span class="token punctuation">,</span>            <span class="token property">"city"</span><span class="token operator">:</span><span class="token string">"北京市"</span><span class="token punctuation">,</span>            <span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"东城"</span><span class="token punctuation">,</span>            <span class="token property">"id"</span><span class="token operator">:</span><span class="token string">"110101"</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"now"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>            <span class="token property">"temp"</span><span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span>            <span class="token property">"feels_like"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>            <span class="token property">"rh"</span><span class="token operator">:</span><span class="token number">73</span><span class="token punctuation">,</span>            <span class="token property">"wind_class"</span><span class="token operator">:</span><span class="token string">"2级"</span><span class="token punctuation">,</span>            <span class="token property">"wind_dir"</span><span class="token operator">:</span><span class="token string">"东风"</span><span class="token punctuation">,</span>            <span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"多云"</span><span class="token punctuation">,</span>            <span class="token property">"prec_1h"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token property">"clouds"</span><span class="token operator">:</span><span class="token number">999999</span><span class="token punctuation">,</span>            <span class="token property">"vis"</span><span class="token operator">:</span><span class="token number">3471</span><span class="token punctuation">,</span>            <span class="token property">"aqi"</span><span class="token operator">:</span><span class="token number">140</span><span class="token punctuation">,</span>            <span class="token property">"pm25"</span><span class="token operator">:</span><span class="token number">107</span><span class="token punctuation">,</span>            <span class="token property">"pm10"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>            <span class="token property">"no2"</span><span class="token operator">:</span><span class="token number">23</span><span class="token punctuation">,</span>            <span class="token property">"so2"</span><span class="token operator">:</span><span class="token number">22</span><span class="token punctuation">,</span>            <span class="token property">"o3"</span><span class="token operator">:</span><span class="token number">70</span><span class="token punctuation">,</span>            <span class="token property">"co"</span><span class="token operator">:</span><span class="token number">1.7</span><span class="token punctuation">,</span>            <span class="token property">"uptime"</span><span class="token operator">:</span><span class="token string">"20200220143500"</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"indexes"</span><span class="token operator">:</span><span class="token punctuation">[</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"晨练指数"</span><span class="token punctuation">,</span>                <span class="token property">"brief"</span><span class="token operator">:</span><span class="token string">"较适宜"</span><span class="token punctuation">,</span>                <span class="token property">"detail"</span><span class="token operator">:</span><span class="token string">"天气阴沉，请避免在林中晨练。"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"洗车指数"</span><span class="token punctuation">,</span>                <span class="token property">"brief"</span><span class="token operator">:</span><span class="token string">"适宜"</span><span class="token punctuation">,</span>                <span class="token property">"detail"</span><span class="token operator">:</span><span class="token string">"天气较好，适合擦洗汽车。"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"感冒指数"</span><span class="token punctuation">,</span>                <span class="token property">"brief"</span><span class="token operator">:</span><span class="token string">"易发"</span><span class="token punctuation">,</span>                <span class="token property">"detail"</span><span class="token operator">:</span><span class="token string">"天凉，昼夜温差大，易感冒"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"紫外线指数"</span><span class="token punctuation">,</span>                <span class="token property">"brief"</span><span class="token operator">:</span><span class="token string">"最弱"</span><span class="token punctuation">,</span>                <span class="token property">"detail"</span><span class="token operator">:</span><span class="token string">"辐射弱，涂擦SPF8-12防晒护肤品。"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"穿衣指数"</span><span class="token punctuation">,</span>                <span class="token property">"brief"</span><span class="token operator">:</span><span class="token string">"较冷"</span><span class="token punctuation">,</span>                <span class="token property">"detail"</span><span class="token operator">:</span><span class="token string">"建议着厚外套加毛衣等服装。"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"运动指数"</span><span class="token punctuation">,</span>                <span class="token property">"brief"</span><span class="token operator">:</span><span class="token string">"较适宜"</span><span class="token punctuation">,</span>                <span class="token property">"detail"</span><span class="token operator">:</span><span class="token string">"气温较低，在户外运动请注意增减衣物。"</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token property">"alerts"</span><span class="token operator">:</span><span class="token punctuation">[</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"道路冰雪"</span><span class="token punctuation">,</span>                <span class="token property">"level"</span><span class="token operator">:</span> <span class="token string">"蓝色预警"</span><span class="token punctuation">,</span>                <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"市气象局发布道路冰雪蓝色预警[IV级/一般]"</span><span class="token punctuation">,</span>                 <span class="token property">"desc"</span><span class="token operator">:</span> "市气象局发布道路冰雪蓝色预警信号<span class="token operator">:</span>受降雪天气影响，                        预计未来 <span class="token number">24</span> 小时我市将出现对交通有影响的道路结冰或积雪，                         请有关部门及广大群众做好防范工作。"            <span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token property">"forecasts"</span><span class="token operator">:</span><span class="token punctuation">[</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"date"</span><span class="token operator">:</span><span class="token string">"2020-02-20"</span><span class="token punctuation">,</span>                <span class="token property">"week"</span><span class="token operator">:</span><span class="token string">"星期四"</span><span class="token punctuation">,</span>                <span class="token property">"high"</span><span class="token operator">:</span><span class="token number">7</span><span class="token punctuation">,</span>                <span class="token property">"low"</span><span class="token operator">:</span><span class="token number">-2</span><span class="token punctuation">,</span>                <span class="token property">"wc_day"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wc_night"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wd_day"</span><span class="token operator">:</span><span class="token string">"东南风"</span><span class="token punctuation">,</span>                <span class="token property">"wd_night"</span><span class="token operator">:</span><span class="token string">"北风"</span><span class="token punctuation">,</span>                <span class="token property">"text_day"</span><span class="token operator">:</span><span class="token string">"多云"</span><span class="token punctuation">,</span>                <span class="token property">"text_night"</span><span class="token operator">:</span><span class="token string">"阴"</span><span class="token punctuation">,</span>                <span class="token property">"aqi"</span><span class="token operator">:</span><span class="token number">93</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"date"</span><span class="token operator">:</span><span class="token string">"2020-02-21"</span><span class="token punctuation">,</span>                <span class="token property">"week"</span><span class="token operator">:</span><span class="token string">"星期五"</span><span class="token punctuation">,</span>                <span class="token property">"high"</span><span class="token operator">:</span><span class="token number">11</span><span class="token punctuation">,</span>                <span class="token property">"low"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>                <span class="token property">"wc_day"</span><span class="token operator">:</span><span class="token string">"4~5级"</span><span class="token punctuation">,</span>                <span class="token property">"wc_night"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wd_day"</span><span class="token operator">:</span><span class="token string">"西北风"</span><span class="token punctuation">,</span>                <span class="token property">"wd_night"</span><span class="token operator">:</span><span class="token string">"西北风"</span><span class="token punctuation">,</span>                <span class="token property">"text_day"</span><span class="token operator">:</span><span class="token string">"多云"</span><span class="token punctuation">,</span>                <span class="token property">"text_night"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"aqi"</span><span class="token operator">:</span><span class="token number">44</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"date"</span><span class="token operator">:</span><span class="token string">"2020-02-22"</span><span class="token punctuation">,</span>                <span class="token property">"week"</span><span class="token operator">:</span><span class="token string">"星期六"</span><span class="token punctuation">,</span>                <span class="token property">"high"</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span>                <span class="token property">"low"</span><span class="token operator">:</span><span class="token number">-2</span><span class="token punctuation">,</span>                <span class="token property">"wc_day"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wc_night"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wd_day"</span><span class="token operator">:</span><span class="token string">"西风"</span><span class="token punctuation">,</span>                <span class="token property">"wd_night"</span><span class="token operator">:</span><span class="token string">"南风"</span><span class="token punctuation">,</span>                <span class="token property">"text_day"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"text_night"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"aqi"</span><span class="token operator">:</span><span class="token number">39</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"date"</span><span class="token operator">:</span><span class="token string">"2020-02-23"</span><span class="token punctuation">,</span>                <span class="token property">"week"</span><span class="token operator">:</span><span class="token string">"星期日"</span><span class="token punctuation">,</span>                <span class="token property">"high"</span><span class="token operator">:</span><span class="token number">11</span><span class="token punctuation">,</span>                <span class="token property">"low"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"wc_day"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wc_night"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wd_day"</span><span class="token operator">:</span><span class="token string">"北风"</span><span class="token punctuation">,</span>                <span class="token property">"wd_night"</span><span class="token operator">:</span><span class="token string">"北风"</span><span class="token punctuation">,</span>                <span class="token property">"text_day"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"text_night"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"aqi"</span><span class="token operator">:</span><span class="token number">65</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"date"</span><span class="token operator">:</span><span class="token string">"2020-02-24"</span><span class="token punctuation">,</span>                <span class="token property">"week"</span><span class="token operator">:</span><span class="token string">"星期一"</span><span class="token punctuation">,</span>                <span class="token property">"high"</span><span class="token operator">:</span><span class="token number">9</span><span class="token punctuation">,</span>                <span class="token property">"low"</span><span class="token operator">:</span><span class="token number">-1</span><span class="token punctuation">,</span>                <span class="token property">"wc_day"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wc_night"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wd_day"</span><span class="token operator">:</span><span class="token string">"东风"</span><span class="token punctuation">,</span>                <span class="token property">"wd_night"</span><span class="token operator">:</span><span class="token string">"东北风"</span><span class="token punctuation">,</span>                <span class="token property">"text_day"</span><span class="token operator">:</span><span class="token string">"多云"</span><span class="token punctuation">,</span>                <span class="token property">"text_night"</span><span class="token operator">:</span><span class="token string">"多云"</span><span class="token punctuation">,</span>                <span class="token property">"aqi"</span><span class="token operator">:</span><span class="token number">38</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"date"</span><span class="token operator">:</span><span class="token string">"2020-02-25"</span><span class="token punctuation">,</span>                <span class="token property">"week"</span><span class="token operator">:</span><span class="token string">"星期二"</span><span class="token punctuation">,</span>                <span class="token property">"high"</span><span class="token operator">:</span><span class="token number">9</span><span class="token punctuation">,</span>                <span class="token property">"low"</span><span class="token operator">:</span><span class="token number">-3</span><span class="token punctuation">,</span>                <span class="token property">"wc_day"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wc_night"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wd_day"</span><span class="token operator">:</span><span class="token string">"东南风"</span><span class="token punctuation">,</span>                <span class="token property">"wd_night"</span><span class="token operator">:</span><span class="token string">"西南风"</span><span class="token punctuation">,</span>                <span class="token property">"text_day"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"text_night"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"aqi"</span><span class="token operator">:</span><span class="token number">27</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"date"</span><span class="token operator">:</span><span class="token string">"2020-02-26"</span><span class="token punctuation">,</span>                <span class="token property">"week"</span><span class="token operator">:</span><span class="token string">"星期三"</span><span class="token punctuation">,</span>                <span class="token property">"high"</span><span class="token operator">:</span><span class="token number">9</span><span class="token punctuation">,</span>                <span class="token property">"low"</span><span class="token operator">:</span><span class="token number">-3</span><span class="token punctuation">,</span>                <span class="token property">"wc_day"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wc_night"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wd_day"</span><span class="token operator">:</span><span class="token string">"西南风"</span><span class="token punctuation">,</span>                <span class="token property">"wd_night"</span><span class="token operator">:</span><span class="token string">"西南风"</span><span class="token punctuation">,</span>                <span class="token property">"text_day"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"text_night"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"aqi"</span><span class="token operator">:</span><span class="token number">26</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token property">"forecast_hours"</span><span class="token operator">:</span><span class="token punctuation">[</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"temp_fc"</span><span class="token operator">:</span><span class="token number">14</span><span class="token punctuation">,</span>                <span class="token property">"wind_class"</span><span class="token operator">:</span><span class="token string">"3~4级"</span><span class="token punctuation">,</span>                <span class="token property">"wind_dir"</span><span class="token operator">:</span><span class="token string">"西南风"</span><span class="token punctuation">,</span>                <span class="token property">"rh"</span><span class="token operator">:</span><span class="token number">15</span><span class="token punctuation">,</span>                <span class="token property">"prec_1h"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"clouds"</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span>                <span class="token property">"data_time"</span><span class="token operator">:</span><span class="token string">"2020-04-01 16:00:00"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"temp_fc"</span><span class="token operator">:</span><span class="token number">14</span><span class="token punctuation">,</span>                <span class="token property">"wind_class"</span><span class="token operator">:</span><span class="token string">"3~4级"</span><span class="token punctuation">,</span>                <span class="token property">"wind_dir"</span><span class="token operator">:</span><span class="token string">"西南风"</span><span class="token punctuation">,</span>                <span class="token property">"rh"</span><span class="token operator">:</span><span class="token number">13</span><span class="token punctuation">,</span>                <span class="token property">"prec_1h"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"clouds"</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span>                <span class="token property">"data_time"</span><span class="token operator">:</span><span class="token string">"2020-04-01 17:00:00"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"temp_fc"</span><span class="token operator">:</span><span class="token number">13</span><span class="token punctuation">,</span>                <span class="token property">"wind_class"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wind_dir"</span><span class="token operator">:</span><span class="token string">"西南风"</span><span class="token punctuation">,</span>                <span class="token property">"rh"</span><span class="token operator">:</span><span class="token number">14</span><span class="token punctuation">,</span>                <span class="token property">"prec_1h"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"clouds"</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span>                <span class="token property">"data_time"</span><span class="token operator">:</span><span class="token string">"2020-04-01 18:00:00"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"temp_fc"</span><span class="token operator">:</span><span class="token number">11</span><span class="token punctuation">,</span>                <span class="token property">"wind_class"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wind_dir"</span><span class="token operator">:</span><span class="token string">"西南风"</span><span class="token punctuation">,</span>                <span class="token property">"rh"</span><span class="token operator">:</span><span class="token number">15</span><span class="token punctuation">,</span>                <span class="token property">"prec_1h"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"clouds"</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span>                <span class="token property">"data_time"</span><span class="token operator">:</span><span class="token string">"2020-04-01 19:00:00"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"temp_fc"</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span>                <span class="token property">"wind_class"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wind_dir"</span><span class="token operator">:</span><span class="token string">"西南风"</span><span class="token punctuation">,</span>                <span class="token property">"rh"</span><span class="token operator">:</span><span class="token number">16</span><span class="token punctuation">,</span>                <span class="token property">"prec_1h"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"clouds"</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span>                <span class="token property">"data_time"</span><span class="token operator">:</span><span class="token string">"2020-04-01 20:00:00"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"temp_fc"</span><span class="token operator">:</span><span class="token number">9</span><span class="token punctuation">,</span>                <span class="token property">"wind_class"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wind_dir"</span><span class="token operator">:</span><span class="token string">"西风"</span><span class="token punctuation">,</span>                <span class="token property">"rh"</span><span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">,</span>                <span class="token property">"prec_1h"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"clouds"</span><span class="token operator">:</span><span class="token number">6</span><span class="token punctuation">,</span>                <span class="token property">"data_time"</span><span class="token operator">:</span><span class="token string">"2020-04-01 21:00:00"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"temp_fc"</span><span class="token operator">:</span><span class="token number">9</span><span class="token punctuation">,</span>                <span class="token property">"wind_class"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wind_dir"</span><span class="token operator">:</span><span class="token string">"西风"</span><span class="token punctuation">,</span>                <span class="token property">"rh"</span><span class="token operator">:</span><span class="token number">20</span><span class="token punctuation">,</span>                <span class="token property">"prec_1h"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"clouds"</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span>                <span class="token property">"data_time"</span><span class="token operator">:</span><span class="token string">"2020-04-01 22:00:00"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"temp_fc"</span><span class="token operator">:</span><span class="token number">8</span><span class="token punctuation">,</span>                <span class="token property">"wind_class"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wind_dir"</span><span class="token operator">:</span><span class="token string">"西风"</span><span class="token punctuation">,</span>                <span class="token property">"rh"</span><span class="token operator">:</span><span class="token number">21</span><span class="token punctuation">,</span>                <span class="token property">"prec_1h"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"clouds"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"data_time"</span><span class="token operator">:</span><span class="token string">"2020-04-01 23:00:00"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"temp_fc"</span><span class="token operator">:</span><span class="token number">7</span><span class="token punctuation">,</span>                <span class="token property">"wind_class"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wind_dir"</span><span class="token operator">:</span><span class="token string">"西北风"</span><span class="token punctuation">,</span>                <span class="token property">"rh"</span><span class="token operator">:</span><span class="token number">26</span><span class="token punctuation">,</span>                <span class="token property">"prec_1h"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"clouds"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"data_time"</span><span class="token operator">:</span><span class="token string">"2020-04-02 00:00:00"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"temp_fc"</span><span class="token operator">:</span><span class="token number">6</span><span class="token punctuation">,</span>                <span class="token property">"wind_class"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wind_dir"</span><span class="token operator">:</span><span class="token string">"西北风"</span><span class="token punctuation">,</span>                <span class="token property">"rh"</span><span class="token operator">:</span><span class="token number">31</span><span class="token punctuation">,</span>                <span class="token property">"prec_1h"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"clouds"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"data_time"</span><span class="token operator">:</span><span class="token string">"2020-04-02 01:00:00"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"temp_fc"</span><span class="token operator">:</span><span class="token number">6</span><span class="token punctuation">,</span>                <span class="token property">"wind_class"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wind_dir"</span><span class="token operator">:</span><span class="token string">"西北风"</span><span class="token punctuation">,</span>                <span class="token property">"rh"</span><span class="token operator">:</span><span class="token number">36</span><span class="token punctuation">,</span>                <span class="token property">"prec_1h"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"clouds"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"data_time"</span><span class="token operator">:</span><span class="token string">"2020-04-02 02:00:00"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"temp_fc"</span><span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">,</span>                <span class="token property">"wind_class"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wind_dir"</span><span class="token operator">:</span><span class="token string">"西北风"</span><span class="token punctuation">,</span>                <span class="token property">"rh"</span><span class="token operator">:</span><span class="token number">39</span><span class="token punctuation">,</span>                <span class="token property">"prec_1h"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"clouds"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"data_time"</span><span class="token operator">:</span><span class="token string">"2020-04-02 03:00:00"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"temp_fc"</span><span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span>                <span class="token property">"wind_class"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wind_dir"</span><span class="token operator">:</span><span class="token string">"西北风"</span><span class="token punctuation">,</span>                <span class="token property">"rh"</span><span class="token operator">:</span><span class="token number">42</span><span class="token punctuation">,</span>                <span class="token property">"prec_1h"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"clouds"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"data_time"</span><span class="token operator">:</span><span class="token string">"2020-04-02 04:00:00"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"temp_fc"</span><span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span>                <span class="token property">"wind_class"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wind_dir"</span><span class="token operator">:</span><span class="token string">"西北风"</span><span class="token punctuation">,</span>                <span class="token property">"rh"</span><span class="token operator">:</span><span class="token number">45</span><span class="token punctuation">,</span>                <span class="token property">"prec_1h"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"clouds"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"data_time"</span><span class="token operator">:</span><span class="token string">"2020-04-02 05:00:00"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"temp_fc"</span><span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">,</span>                <span class="token property">"wind_class"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wind_dir"</span><span class="token operator">:</span><span class="token string">"西北风"</span><span class="token punctuation">,</span>                <span class="token property">"rh"</span><span class="token operator">:</span><span class="token number">40</span><span class="token punctuation">,</span>                <span class="token property">"prec_1h"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"clouds"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"data_time"</span><span class="token operator">:</span><span class="token string">"2020-04-02 06:00:00"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"temp_fc"</span><span class="token operator">:</span><span class="token number">7</span><span class="token punctuation">,</span>                <span class="token property">"wind_class"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wind_dir"</span><span class="token operator">:</span><span class="token string">"西北风"</span><span class="token punctuation">,</span>                <span class="token property">"rh"</span><span class="token operator">:</span><span class="token number">34</span><span class="token punctuation">,</span>                <span class="token property">"prec_1h"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"clouds"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"data_time"</span><span class="token operator">:</span><span class="token string">"2020-04-02 07:00:00"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"temp_fc"</span><span class="token operator">:</span><span class="token number">8</span><span class="token punctuation">,</span>                <span class="token property">"wind_class"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wind_dir"</span><span class="token operator">:</span><span class="token string">"西北风"</span><span class="token punctuation">,</span>                <span class="token property">"rh"</span><span class="token operator">:</span><span class="token number">29</span><span class="token punctuation">,</span>                <span class="token property">"prec_1h"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"clouds"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"data_time"</span><span class="token operator">:</span><span class="token string">"2020-04-02 08:00:00"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"temp_fc"</span><span class="token operator">:</span><span class="token number">11</span><span class="token punctuation">,</span>                <span class="token property">"wind_class"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wind_dir"</span><span class="token operator">:</span><span class="token string">"西北风"</span><span class="token punctuation">,</span>                <span class="token property">"rh"</span><span class="token operator">:</span><span class="token number">29</span><span class="token punctuation">,</span>                <span class="token property">"prec_1h"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"clouds"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"data_time"</span><span class="token operator">:</span><span class="token string">"2020-04-02 09:00:00"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"temp_fc"</span><span class="token operator">:</span><span class="token number">13</span><span class="token punctuation">,</span>                <span class="token property">"wind_class"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wind_dir"</span><span class="token operator">:</span><span class="token string">"西北风"</span><span class="token punctuation">,</span>                <span class="token property">"rh"</span><span class="token operator">:</span><span class="token number">29</span><span class="token punctuation">,</span>                <span class="token property">"prec_1h"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"clouds"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"data_time"</span><span class="token operator">:</span><span class="token string">"2020-04-02 10:00:00"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"temp_fc"</span><span class="token operator">:</span><span class="token number">16</span><span class="token punctuation">,</span>                <span class="token property">"wind_class"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wind_dir"</span><span class="token operator">:</span><span class="token string">"西北风"</span><span class="token punctuation">,</span>                <span class="token property">"rh"</span><span class="token operator">:</span><span class="token number">29</span><span class="token punctuation">,</span>                <span class="token property">"prec_1h"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"clouds"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"data_time"</span><span class="token operator">:</span><span class="token string">"2020-04-02 11:00:00"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"temp_fc"</span><span class="token operator">:</span><span class="token number">17</span><span class="token punctuation">,</span>                <span class="token property">"wind_class"</span><span class="token operator">:</span><span class="token string">"3~4级"</span><span class="token punctuation">,</span>                <span class="token property">"wind_dir"</span><span class="token operator">:</span><span class="token string">"西北风"</span><span class="token punctuation">,</span>                <span class="token property">"rh"</span><span class="token operator">:</span><span class="token number">24</span><span class="token punctuation">,</span>                <span class="token property">"prec_1h"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"clouds"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"data_time"</span><span class="token operator">:</span><span class="token string">"2020-04-02 12:00:00"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"temp_fc"</span><span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">,</span>                <span class="token property">"wind_class"</span><span class="token operator">:</span><span class="token string">"3~4级"</span><span class="token punctuation">,</span>                <span class="token property">"wind_dir"</span><span class="token operator">:</span><span class="token string">"西北风"</span><span class="token punctuation">,</span>                <span class="token property">"rh"</span><span class="token operator">:</span><span class="token number">19</span><span class="token punctuation">,</span>                <span class="token property">"prec_1h"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"clouds"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"data_time"</span><span class="token operator">:</span><span class="token string">"2020-04-02 13:00:00"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"temp_fc"</span><span class="token operator">:</span><span class="token number">19</span><span class="token punctuation">,</span>                <span class="token property">"wind_class"</span><span class="token operator">:</span><span class="token string">"3~4级"</span><span class="token punctuation">,</span>                <span class="token property">"wind_dir"</span><span class="token operator">:</span><span class="token string">"西北风"</span><span class="token punctuation">,</span>                <span class="token property">"rh"</span><span class="token operator">:</span><span class="token number">14</span><span class="token punctuation">,</span>                <span class="token property">"prec_1h"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"clouds"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"data_time"</span><span class="token operator">:</span><span class="token string">"2020-04-02 14:00:00"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"晴"</span><span class="token punctuation">,</span>                <span class="token property">"temp_fc"</span><span class="token operator">:</span><span class="token number">19</span><span class="token punctuation">,</span>                <span class="token property">"wind_class"</span><span class="token operator">:</span><span class="token string">"&lt;3级"</span><span class="token punctuation">,</span>                <span class="token property">"wind_dir"</span><span class="token operator">:</span><span class="token string">"西风"</span><span class="token punctuation">,</span>                <span class="token property">"rh"</span><span class="token operator">:</span><span class="token number">17</span><span class="token punctuation">,</span>                <span class="token property">"prec_1h"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"clouds"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                <span class="token property">"data_time"</span><span class="token operator">:</span><span class="token string">"2020-04-02 15:00:00"</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token property">"message"</span><span class="token operator">:</span><span class="token string">"success"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>    </details>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 机器人 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一个可以发送色图的QQ机器人</title>
      <link href="/2022/02/17/oicq-setu-boot/"/>
      <url>/2022/02/17/oicq-setu-boot/</url>
      
        <content type="html"><![CDATA[<blockquote><p>创建一个可以自动发送色图的QQ机器人，指定关键词或者定时发送。</p></blockquote><h3 id="框架"><a href="#框架" class="headerlink" title="框架"></a>框架</h3><ul><li><a href="https://github.com/takayama-lily/oicq">OICQ</a>,QQ(安卓)协议基于Node.js的实现。</li><li>API，<a href="https://api.lolicon.app/#/setu">luolicon</a></li></ul><span id="more"></span><hr><h3 id="环境安装"><a href="#环境安装" class="headerlink" title="环境安装"></a>环境安装</h3><h4 id="安装VSCODE"><a href="#安装VSCODE" class="headerlink" title="安装VSCODE"></a>安装VSCODE</h4><p><a href="https://code.visualstudio.com/">官方下载</a></p><h4 id="安装node"><a href="#安装node" class="headerlink" title="安装node"></a>安装node</h4><p><a href="https://nodejs.org/zh-cn/">官方下载</a></p><hr><h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><p>创建一个文件夹，比如在桌面新建一个setu-boot文件夹<br>打开文件夹，右键-&gt;通过vscode打开</p><h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><p>在vscode中的终端窗口输入<code>node -v</code>来检查node.js是否正常</p><h5 id="需要的安装"><a href="#需要的安装" class="headerlink" title="需要的安装"></a>需要的安装</h5><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># 首先安装yarnnpm install -g yarn# 安装OICQyarn add oicq# 安装node-fetchyarn add node-fetch# 安装定时模块yarn add node-schedule<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>完成后修改package.json,添加<code>&quot;type&quot;: &quot;module&quot;</code></p><h5 id="新建index-js"><a href="#新建index-js" class="headerlink" title="新建index.js"></a>新建index.js</h5><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> createClient <span class="token keyword">from</span> <span class="token string">'oicq'</span><span class="token keyword">const</span> _qq_account <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">platform</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>    <span class="token literal-property property">uin</span><span class="token operator">:</span> 你的<span class="token constant">QQ</span>号<span class="token punctuation">,</span>    <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">'密码'</span><span class="token punctuation">,</span>    <span class="token literal-property property">logLevel</span><span class="token operator">:</span> <span class="token string">"info"</span><span class="token punctuation">,</span>  <span class="token comment">//trace,debug,info,warn,error,mark</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> bot <span class="token operator">=</span> <span class="token function">createClient</span><span class="token punctuation">(</span>_qq_account<span class="token punctuation">.</span>uin<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">platform</span><span class="token operator">:</span> _qq_account<span class="token punctuation">.</span>platform<span class="token punctuation">,</span> <span class="token literal-property property">log_level</span><span class="token operator">:</span> _qq_account<span class="token punctuation">.</span>logLevel <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>bot<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"system.login.qrcode"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">"扫码后按Enter完成登录"</span><span class="token punctuation">)</span>process<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span>exports<span class="token punctuation">.</span>bot <span class="token operator">=</span> bot<span class="token comment">// template plugins</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./plugin-setu"</span><span class="token punctuation">)</span> <span class="token comment">//hello world</span>process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"unhandledRejection"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">reason<span class="token punctuation">,</span> promise</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Unhandled Rejection at:'</span><span class="token punctuation">,</span> promise<span class="token punctuation">,</span> <span class="token string">'reason:'</span><span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="新建plugin-setu-js"><a href="#新建plugin-setu-js" class="headerlink" title="新建plugin-setu.js"></a>新建plugin-setu.js</h5><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> fetch <span class="token keyword">from</span> <span class="token string">'node-fetch'</span><span class="token punctuation">;</span><span class="token keyword">import</span> segment <span class="token keyword">from</span> <span class="token string">'oicq'</span><span class="token keyword">import</span> bot <span class="token keyword">from</span> <span class="token string">'./index'</span><span class="token keyword">import</span> schedule <span class="token keyword">from</span> <span class="token string">'node-schedule'</span>bot<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"message.group"</span><span class="token punctuation">,</span> <span class="token parameter">msg</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token comment">// console.log(msg)</span><span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>raw_message<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'色图'</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.lolicon.app/setu/v2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> setu <span class="token operator">=</span> <span class="token punctuation">[</span>      segment<span class="token punctuation">.</span><span class="token function">image</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>urls<span class="token punctuation">.</span>original<span class="token punctuation">)</span>    <span class="token punctuation">]</span>    msg<span class="token punctuation">.</span><span class="token function">reply</span><span class="token punctuation">(</span>setu<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        msg<span class="token punctuation">.</span>group<span class="token punctuation">.</span><span class="token function">recallMsg</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>message_id<span class="token punctuation">)</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token number">20000</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token comment">//20S后撤回</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h5><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">node index.js# 或者使用pm2管理npm install -g pm2pm2 start index.js --name setu<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 机器人 </tag>
            
            <tag> Node.js </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>微软office365 E5开发者账户调用API续订</title>
      <link href="/2022/02/17/E5-renew/"/>
      <url>/2022/02/17/E5-renew/</url>
      
        <content type="html"><![CDATA[<blockquote><p>微软开发者账户提供25个账号，每个账号可享有5T的云盘空间。<br>注册很简单，但是续订也许对于小白并不简单，运气也有一定比重，虽然也有极少的非酋会续不上。</p></blockquote><p>Api续订的方式有很多</p><span id="more"></span><ul><li>调用OneDrive的有oneIndex，Cloudreve，onemanger等，平时多使用这些网盘工具，这个工具的成功几率玄学，反正有在用，当成自己的不限速网盘也是不错的。</li><li>Windows电脑上运行软件，<code>MS365 E5 Renew Plus</code>，传送门<a href="https://e5renew.com/">E5 Renew Plus 官方网站</a>，很高的几率续订成功，只要你平时上班时后台运行即可，有很好的文档和健全的生态，据官方介绍，没有续费不成功的案例，可以说是非常niubility了。</li><li>网页端，如果你是学生党，没发长时间开着电脑，可以尝试自建服务器或者使用别人的服务器，<code>Microsoft 365 E5 Renew X</code>你可以自己用或者分享给大家一起用，传送门<a href="https://blog.csdn.net/qq_33212020/article/details/119747634">E5 调用API续订服务：Microsoft 365 E5 Renew X_SundayRX的博客-CSDN博客_e5续订</a>, 如果有群晖等NAS类终端，或者可以docker的软路由等小主机，可以使用docker。</li><li>需要注意的点是，微软会为AD账户强制启用双重验证，在使用此教程时必须关闭双重认证，步骤为打开<a href="https://aad.portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/Overview">Azure Active Directory</a>,然后把滑块滑动至否即可，注意需要使用管理员账户才有权限更改。<img src="/images/e5/1648451312(1).jpg" alt="关闭双重验证" loading="lazy"></li><li>github, AutoApi, 这个去github上搜就行了，有很多，安装教程走一遍基本上ok，也可以fork我的<a href="https://github.com/oyzbmmmm/365RefreshApi">oyzbmmmm/365RefreshApi (github.com)</a></li><li>电报机器人，较为简单<pre class="line-numbers language-html" data-language="html"><code class="language-html">@E5Sub_bot@CRE5bot@EUe5bot@E5_subbot@kre5_bot@E5subot@raindev_bot@rldsBot@NawE5SubBot@officeE5_bot (@kingyii: 唯一一个使用 kubernetes 运行的 e5 机器人)@SubE5_Bot@subfore5_bot@My_e5_bot@One365E5_bot更多 bot 加 tg 群组 https://t.me/e5subbottelegram bot 源码 https://github.com/iyear/E5SubBot使用的时候给 bot 发送 然后复制那个 secret 密码，登录你需要续订的 e5 账号，获取 ID根据他给的格式填入信息并发送。然后再去跳转连接复制那个 localhost… 的网址 + 空格 + 随便一个别名（用于管理）并发送即可绑定成功<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>本文不是原创，记录下，防止资源丢失。</li></ul><p>有问题，可以提出。</p>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tool </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>这是一个文章模板</title>
      <link href="/2020/03/05/hello-world/"/>
      <url>/2020/03/05/hello-world/</url>
      
        <content type="html"><![CDATA[<blockquote><p>这是引用</p></blockquote><hr><p>这里是摘要</p><span id="more"></span><p>这里是更多内容</p><p>额外的头部字段</p><ul><li>author: 设置作者则会显示</li><li>email: 自动根据邮箱获取 Gravatar 头像</li><li>toc: 是否显示目录（文章 post 默认显示，页面 post 默认不显示）</li><li>readmore: 将会首页卡片摘要末尾强制显示一个 阅读更多 按钮</li><li>hideTime: 强制隐藏时间显示</li></ul><hr><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">title: xxxauthor: 云游君email: me@yunyoujun.cnreadmore: truehideTime: true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><p>description: 描述（只出现在预览卡片上，不出现在正文中）（默认使用 400 字重以表强调，略细于加粗字体）<br>excerpt: 摘要（不需要在 Front-matter 中设置，通过 <!-- more --> 截断实现，预览卡片与正文中均出现）</p><hr><pre class="line-numbers language-none"><code class="language-none">title: xxxdescription: xxxxxxx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><hr><h5 id="此处是-hexo-theme-yun-对默认-Markdown-一些样式的扩展。"><a href="#此处是-hexo-theme-yun-对默认-Markdown-一些样式的扩展。" class="headerlink" title="此处是 hexo-theme-yun 对默认 Markdown 一些样式的扩展。"></a>此处是 hexo-theme-yun 对默认 Markdown 一些样式的扩展。</h5><div class="primary"><blockquote><p>Primary</p></blockquote></div><div class="success"><blockquote><p>Success</p></blockquote></div><div class="warning"><blockquote><p>Warning</p></blockquote></div><div class="danger"><blockquote><p>Danger</p></blockquote></div><div class="info"><blockquote><p>Info</p></blockquote></div><div class="gray"><blockquote><p>Gray</p></blockquote></div><div class="yellow"><blockquote><p>Yellow</p></blockquote></div><details>  <summary>使用方式</summary>  <pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>primary<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>> Primary<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>success<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>> Success<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>warning<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>> Warning<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>danger<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>> Danger<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>info<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>> Info<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>gray<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>> Gray<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>yellow<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>> Yellow<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></details><hr><h5 id="Details-折叠"><a href="#Details-折叠" class="headerlink" title="Details 折叠"></a>Details 折叠</h5><details>  <summary>Summary</summary>  Content  </details><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>details</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>summary</span><span class="token punctuation">></span></span>Summary<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>summary</span><span class="token punctuation">></span></span>  Content<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>details</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 建站 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
